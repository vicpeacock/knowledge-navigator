# Docker Compose per testare il deployment cloud localmente
# Usa l'immagine Docker buildata invece di Ollama locale
version: '3.8'

services:
  # Usa PostgreSQL, ChromaDB e Google Workspace MCP esistenti dal docker-compose.yml principale
  # (assumiamo che siano giÃ  in esecuzione)

  backend-cloud-test:
    image: knowledge-navigator-backend:test
    container_name: knowledge-navigator-backend-cloud-test
    ports:
      - "8002:8000"  # Porta diversa per non confliggere con backend locale
    environment:
      # Database (usa PostgreSQL esistente)
      - DATABASE_URL=postgresql+asyncpg://knavigator:knavigator_pass@host.docker.internal:5432/knowledge_navigator
      
      # ChromaDB (usa ChromaDB esistente)
      - CHROMADB_HOST=host.docker.internal
      - CHROMADB_PORT=8001
      
      # LLM Provider - Gemini per cloud
      - LLM_PROVIDER=gemini
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash}
      
      # Google OAuth (per integrazioni)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI_CALENDAR=http://localhost:8002/api/integrations/calendars/oauth/callback
      - GOOGLE_REDIRECT_URI_EMAIL=http://localhost:8002/api/integrations/emails/oauth/callback
      
      # Encryption
      - CREDENTIALS_ENCRYPTION_KEY=${CREDENTIALS_ENCRYPTION_KEY:-your-32-byte-encryption-key-change-me}
      
      # JWT
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-jwt-secret-key-change-in-production}
      
      # Port
      - PORT=8000
      
      # Logging
      - LOG_LEVEL=INFO
      
      # MCP Gateway (se configurato)
      # Dal container Docker, usa host.docker.internal per accedere a servizi sulla macchina host
      - MCP_GATEWAY_URL=${MCP_GATEWAY_URL:-http://host.docker.internal:8080}
      - MCP_GATEWAY_AUTH_TOKEN=${MCP_GATEWAY_AUTH_TOKEN:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Per accedere a servizi host da container
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  frontend-cloud-test:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        NEXT_PUBLIC_API_URL: http://localhost:8002
    container_name: knowledge-navigator-frontend-cloud-test
    ports:
      - "3004:3000"  # Porta diversa per non confliggere con frontend locale (3003)
    environment:
      - PORT=3000
      - NODE_ENV=production
    depends_on:
      backend-cloud-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Per accedere a servizi host da container

